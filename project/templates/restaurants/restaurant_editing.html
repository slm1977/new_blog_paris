{% extends "bootstrap/base.html" %}
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
{% block content %}

<form style="margin-left:10px;" id="editing_form" method="POST", action="{{url_for("restaurants.save_restaurant")}}">
<p>

    <div class="field">
        <div class="control">
            <label for="rest_title">Nome del ristorante: </label>
            <input name="rest_title" id="rest_title"  onchange="notifyChanges()" type="text"
                   size="100%"
                   value="{{restaurant.name if restaurant != None }}" required/><br>
        </div>
    </div>


<div class="field">
    <div class="control">
        <label for="visible_state">Rendi il ristorante visibile agli utenti </label>
        <input class="custom-control-input" type="checkbox" onchange="notifyChanges()"
               id="visible_state" {{'checked' if restaurant != None and restaurant.visible==True }}/><br>
    </div>
</div>

</br>

<div class="field">
    <label for="zones">Zona: </label>
<select id="zones">
    {% for z in zones %}
     <option value="{{z.id}}" size="100%" {{'selected' if restaurant!=None and restaurant.zone.id==z.id}}>{{z.name}}</option>
    {% endfor %}
</select>
</div>

<div class="field">
        <div class="control">
            <label for="orari">Orari: </label>
            <input name="orari" id="orari"  onchange="notifyChanges()" type="text"
                   size="80%"
                   value="{{restaurant.orari if restaurant != None }}" /><br>
        </div>
    </div>

<div class="field">
        <div class="control">
            <label for="address">Indirizzo: </label>
            <input name="address" id="address"  onchange="notifyChanges()" type="text"
                   size="80%"
                   value="{{restaurant.address if restaurant != None }}" />
            <button type="button" id="geocodeButton" class="btn btn-primary" onclick='geocodeAddress()'>
      Trova
    </button>
        </div>

    <div class="osm-map" id="restaurant_map"></div>

    </div>

</br>


<div class="field">
    <label for="topic" style="display:block;">Di che cosa si tratta?</label>
<textarea id="topic" rows="2" cols="80">
{{ restaurant.topic if restaurant!=None}}
</textarea>
</div>
</br>

<div class="field">
    <label for="description" style="display:block;">Recensioni e suggerimenti</label>
<textarea id="description" rows="5" cols="80">
{{ restaurant.description if restaurant!=None}}
</textarea>
</div>
</br>

<!-- Button trigger modal -->
    <button type="button" id="exitButton" class="btn btn-primary">
      Esci
    </button>

    <input type="submit" id="saveButton" class="btn btn-primary" value="Salva"/>

    <button type="button" id="deleteButton" class="btn btn-danger">
      Elimina
    </button>

<div style="margin-top:10px;" class="alert" role="alert" id="formResponse">
</div>
</p>



</form>


<!-- Modal Save Page -->
<div class="modal fade" id="confirmExitModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Modifiche non ancora salvate</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Salvare le modifiche prima di uscire?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="exitFromEditing(true)" data-dismiss="modal">Si</button>
        <button type="button" class="btn btn-secondary" onclick="exitFromEditing(false)" data-dismiss="modal">No</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annulla</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Modal Save Page -->


<!-- Modal Delete Page -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLongTitle">Eliminazione Ristorante</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Si è sicuri di voler eliminare il ristorante corrente?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick='deleteRestaurant()' data-dismiss="modal">Si</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
      </div>
    </div>
  </div>
</div>
<!-- End of Modal Save Page -->


{% endblock %}


{% block scripts %}
{{super()}}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>


    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

    <script type="text/javascript">
    var exitRequest = false;
    var modified = false;
    var restaurant_id = {{restaurant.id if restaurant != None else -1 }}

    var latitude = "48.8925";
    var longitude = "2.3444";
    var map = null;
    var marker = null;
    var GEO_KEY="";

 function return_to_restaurant()
 {
    // se la pagina è stata creata ricarico quella
    if (restaurant_id>0)
            {
             console.log("Ho a che fare con una pagina già esistente");
             window.location.href=`/load_restaurant/${restaurant_id}/`;
            }
        else
            {
              window.location.href="/";
            }
 }


 function exitOrSave()
    {
     if (!modified)
     {
        return_to_restaurant();
     }
     else
     {
        $('#confirmExitModal').modal('show');
      }
    }


function confirmDeleteRestaurant()
    {
    $('#confirmDeleteModal').modal('show');
    }

function deleteRestaurant()
{
   var restaurant_id = {{restaurant.id if restaurant != None else -1 }}
   //if (restaurant_id<0)
   //window.location.href= "/"
   //else
   //window.location.href= "/delete/" + page_id;
}


function notifyChanges()
{
    modified = true;
     $('#formResponse').removeClass("alert-success");
     $('#formResponse').addClass("alert-danger");
     $('#formResponse').html('Da salvare');
}


function exitFromEditing(saveOnExit)
        {
        exitRequest = true;

        if (saveOnExit && modified==true)
        {
        $('#saveButton').submit();
        }
        else
        {
          return_to_restaurant();
        }


        }




        // Shorthand for $( document ).ready()
        $(function() {
            console.log( "ready!" );
            exitRequest = false;
            modified = false;

            $("#exitButton").click(function(){
                    exitOrSave();
                  });

             $("#deleteButton").click(function(){
                    confirmDeleteRestaurant();
                  });



            var frm = $('#editing_form');
            //var ser = frm.serialize();
            //console.log("Form serializzato");
            //console.log($('#editing_form').html());


            frm.submit(function (e) {

                e.preventDefault();

                $.ajax({
                    type: frm.attr('method'),
                    url: frm.attr('action'),
                    data: { 'content': CKEDITOR.instances.editor.getData(),
                             'menu_title' : $('#menu_title').val(),
                             'visible' : $('#visible_state').is(":checked"),
                             'id' : page_id
                        },
                    success: function (data) {
                        console.log('Submission was successful.');
                        console.log(data);
                        if (data["success"]  == true)
                            {
                                modified = false;
                                // aggiorno il page_id della pagina!
                                page_id = parseInt(data["page_id"]);

                                $('#formResponse').removeClass("alert-danger");
                                $('#formResponse').addClass("alert-success");
                                $('#formResponse').html(data["message"]);

                                if (exitRequest==true)
                                return_to_restaurant();
                            }
                           else

                                 {
                                 // in caso di problemi annullo la richiesta di uscita
                                 exitRequest = false;
                                $('#formResponse').removeClass("alert-success");
                                $('#formResponse').addClass("alert-danger");
                                $('#formResponse').html(data["message"]);
                                }

                    },
                    error: function (data) {
                        console.log('An error occurred.');
                        console.log(data);
                        // in caso di problemi annullo la richiesta di uscita
                        exitRequest==false;
                        $('#formResponse').removeClass("alert-success");
                        $('#formResponse').addClass("alert-danger");
                        $('#formResponse').html("Si sono verificati problemi nel salvataggio: %s" % data);
                    },
                });// AJAX end


            });  // frm submit end

        }); // function END


// Gestione della mappa del ristorante


    //https://gis.stackexchange.com/questions/43766/downloading-metro-stations-of-paris-from-openstreetmap
      $(function()  {
        console.log("DOC PRONTO");


         // Where you want to render the map.
          var element = document.getElementById('restaurant_map');

          // Height has to be set. You can do this in CSS too.
          //element.style = 'height:250px; width:100%;';

          // https://leafletjs.com/examples/custom-icons/


          // Create Leaflet map on map element.
          map = L.map(element);

          // Add OSM tile leayer to the Leaflet map.
          L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);


          // markers creative commons
           //https://mapicons.mapsmarker.com/numbers-letters/numbers/?style=classic&custom_color=d607d6
          //https://wiki.openstreetmap.org/wiki/Marker_API#Examples

          let marker_coords = L.latLng( latitude, longitude);

          marker = L.marker(marker_coords, {draggable:true});
          marker.addTo(map);
          // Set map's center to target with zoom 14.
          map.setView(marker_coords, 12);
        });


         <!-- Load jQuery from a CDN or your server -->


    function geocode(query){
      $.ajax({
        url: 'https://api.opencagedata.com/geocode/v1/json',
        method: 'GET',
        data: {
          'key': GEO_KEY,
          'q': query,
          'no_annotations': 1
          // see other optional params:
          // https://opencagedata.com/api#forward-opt
        },
        dataType: 'json',
        statusCode: {
          200: function(response){  // success
            console.log(response.results[0].geometry);
            console.log(response.results[0].formatted);
            latitude = response.results[0].geometry["lat"];
            longitude = response.results[0].geometry["lng"];
            let marker_coords = L.latLng( latitude, longitude);
           console.log("Creo il nuovo marker della mappa");

           // rimuovo il marker e lo ricreo riaggiungendolo
           // alla mappa con le coordinate aggiornate
           marker.remove();
           marker = L.marker(marker_coords, {draggable:true});
           marker.addTo(map);

          // Set map's center to target with zoom 14.

          map.setView(marker_coords, 12);
          },
          402: function(){
            console.log('hit free-trial daily limit');
            console.log('become a customer: https://opencagedata.com/pricing');
          }
          // other possible response codes:
          // https://opencagedata.com/api#codes
        }
      });
    }

    function geocodeAddress()
    {
      let address = $("#address").val();
      geocode(address);
    }


// Fine gestione della mappa del ristorante


</script>


{% endblock %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
<link rel="stylesheet" href="{{url_for('.static', filename='css/home.css')}}">
<link href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" rel="stylesheet"/>

<style>
 /* Set the size of the div element that contains the map */
      .osm-map {
        height: 250px;  /* The height  */
        width: 250px;  /* The width  */
        padding: 20px;
        margin-right: 20px;
        margin-bottom: 20px;
        margin-top: 20px;

       }
</style>

{% endblock %}
